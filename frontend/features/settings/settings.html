<!-- Settings Modal -->
<div v-if="showSettingsModal" class="settings-modal">
    <div class="settings-container">
        <div class="settings-header">
            <h2 class="settings-title">Paramètres</h2>
            <button class="settings-close" @click="closeSettings">✕</button>
        </div>

        <div class="settings-tabs">
            <div
                class="settings-tab"
                :class="{ active: settingsTab === 'profile' }"
                @click="settingsTab = 'profile'"
            >
                Profil
            </div>
            <div
                class="settings-tab"
                :class="{ active: settingsTab === 'security' }"
                @click="settingsTab = 'security'"
            >
                Sécurité
            </div>
            <div
                class="settings-tab"
                :class="{ active: settingsTab === 'legal' }"
                @click="settingsTab = 'legal'"
            >
                Mentions légales
            </div>
            <div
                class="settings-tab"
                :class="{ active: settingsTab === 'account' }"
                @click="settingsTab = 'account'"
            >
                Compte
            </div>
        </div>

        <!-- Profile Tab -->
        <div v-if="settingsTab === 'profile'" class="settings-content">
            <h3 class="section-title">Informations du profil</h3>

            <div class="settings-section">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input
                        type="email"
                        :value="user?.email"
                        class="settings-input"
                        disabled
                    >
                    <small class="form-help">L'adresse email ne peut pas être modifiée</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Date de création du compte</label>
                    <input
                        type="text"
                        :value="formatDate(user?.created_at)"
                        class="settings-input"
                        disabled
                    >
                </div>

                <div class="info-box">
                    <p>Les informations du profil sont actuellement en lecture seule.</p>
                    <p>Vous pouvez modifier votre mot de passe dans l'onglet "Sécurité".</p>
                </div>
            </div>
        </div>

        <!-- Security Tab -->
        <div v-if="settingsTab === 'security'" class="settings-content">
            <h3 class="section-title">Sécurité</h3>

            <div class="settings-section">
                <h4 class="subsection-title">Modifier le mot de passe</h4>

                <form @submit.prevent="updatePassword" class="password-form">
                    <div class="form-group">
                        <label class="form-label">Mot de passe actuel</label>
                        <input
                            type="password"
                            v-model="passwordForm.current_password"
                            class="settings-input"
                            required
                            minlength="6"
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label">Nouveau mot de passe</label>
                        <input
                            type="password"
                            v-model="passwordForm.new_password"
                            class="settings-input"
                            required
                            minlength="6"
                        >
                        <small class="form-help">Minimum 6 caractères</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Confirmer le nouveau mot de passe</label>
                        <input
                            type="password"
                            v-model="passwordForm.confirm_password"
                            class="settings-input"
                            required
                            minlength="6"
                        >
                    </div>

                    <button
                        type="submit"
                        class="settings-button"
                        :disabled="isLoadingPassword"
                    >
                        {{ isLoadingPassword ? 'Modification...' : 'Modifier le mot de passe' }}
                    </button>

                    <div v-if="passwordSuccess" class="success-message">
                        ✓ Mot de passe modifié avec succès
                    </div>
                    <div v-if="passwordError" class="error-message">
                        {{ passwordError }}
                    </div>
                </form>
            </div>
        </div>

        <!-- Legal Tab -->
        <div v-if="settingsTab === 'legal'" class="settings-content">
            <h3 class="section-title">Mentions légales</h3>

            <div class="settings-section">
                <h4 class="subsection-title">Politique de confidentialité</h4>
                <div class="legal-content">
                    <p><strong>Politique de non-conservation des conversations</strong></p>
                    <p>Les échanges entre l'utilisateur et l'assistant juridique sont <strong>temporaires</strong> et <strong>supprimés automatiquement</strong> à la fermeture de la session.</p>
                    <p><strong>Aucune donnée de conversation n'est conservée par la plateforme.</strong></p>

                    <p class="mt-3"><strong>Export volontaire</strong></p>
                    <p>Vous pouvez à tout moment exporter vos conversations au format PDF. Cette copie locale est <strong>hors de notre responsabilité</strong>.</p>

                    <p class="mt-3"><strong>Données personnelles</strong></p>
                    <ul class="legal-list">
                        <li>Email et mot de passe (chiffré) pour l'authentification</li>
                        <li>Date de création du compte</li>
                        <li>Date de consentement aux CGU et politique de confidentialité</li>
                    </ul>

                    <p class="mt-3"><strong>Vos droits RGPD</strong></p>
                    <ul class="legal-list">
                        <li>Droit d'accès à vos données personnelles</li>
                        <li>Droit de modification de vos données</li>
                        <li>Droit à l'effacement de votre compte (voir onglet "Compte")</li>
                    </ul>
                </div>

                <button @click="viewPrivacyPolicy" class="settings-button-outline mt-3">
                    Voir la politique complète
                </button>

                <hr class="section-divider">

                <h4 class="subsection-title">Conditions d'utilisation</h4>
                <div class="legal-content">
                    <p><strong>Non-conservation des conversations</strong></p>
                    <p>MIBS ne stocke pas les conversations. Aucune donnée de chat n'est conservée après la fermeture de session.</p>

                    <p class="mt-3"><strong>Export volontaire</strong></p>
                    <p>L'export PDF est une action volontaire de l'utilisateur. La plateforme n'est pas responsable du contenu exporté ni de son utilisation.</p>

                    <p class="mt-3"><strong>Responsabilité</strong></p>
                    <p>L'assistant juridique fournit des informations à titre indicatif. Il ne remplace pas un conseil juridique professionnel.</p>

                    <p class="mt-3"><strong>Consentement</strong></p>
                    <p>Vous avez accepté ces conditions lors de votre inscription le {{ formatDate(user?.consent_date) }}.</p>
                </div>

                <button @click="viewTermsOfUse" class="settings-button-outline mt-3">
                    Voir les conditions complètes
                </button>
            </div>
        </div>

        <!-- Account Tab -->
        <div v-if="settingsTab === 'account'" class="settings-content">
            <h3 class="section-title">Gestion du compte</h3>

            <div class="settings-section">
                <div class="info-box">
                    <p><strong>Email:</strong> {{ user?.email }}</p>
                    <p><strong>Compte créé le:</strong> {{ formatDate(user?.created_at) }}</p>
                    <p><strong>Statut:</strong> {{ getRoleLabel(user?.role) }}</p>
                </div>

                <hr class="section-divider">

                <h4 class="subsection-title danger-zone">Zone de danger</h4>
                <p class="danger-text">La suppression de votre compte est irréversible. Toutes vos données personnelles seront définitivement effacées conformément au RGPD.</p>

                <div v-if="user?.account_deletion_requested" class="warning-box">
                    <p><strong>⚠️ Suppression programmée</strong></p>
                    <p>Votre compte est programmé pour suppression le {{ formatDate(user?.deletion_request_date) }}.</p>
                    <button @click="cancelDeletion" class="settings-button-outline">
                        Annuler la suppression
                    </button>
                </div>

                <div v-else>
                    <button @click="showDeleteConfirmation = true" class="settings-button-danger">
                        Supprimer mon compte
                    </button>
                </div>

                <!-- Delete Confirmation Modal -->
                <div v-if="showDeleteConfirmation" class="confirmation-overlay">
                    <div class="confirmation-box">
                        <h4>Confirmer la suppression</h4>
                        <p>Cette action est <strong>irréversible</strong>. Toutes vos données seront définitivement supprimées.</p>

                        <div class="form-group">
                            <label class="form-label">Entrez votre mot de passe pour confirmer</label>
                            <input
                                type="password"
                                v-model="deleteForm.password"
                                class="settings-input"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label class="checkbox-label">
                                <input
                                    type="checkbox"
                                    v-model="deleteForm.confirmation"
                                >
                                Je comprends que cette action est irréversible
                            </label>
                        </div>

                        <div class="confirmation-buttons">
                            <button @click="showDeleteConfirmation = false" class="settings-button-outline">
                                Annuler
                            </button>
                            <button
                                @click="deleteAccount"
                                class="settings-button-danger"
                                :disabled="!deleteForm.confirmation || !deleteForm.password || isLoadingDelete"
                            >
                                {{ isLoadingDelete ? 'Suppression...' : 'Supprimer définitivement' }}
                            </button>
                        </div>

                        <div v-if="deleteError" class="error-message mt-2">
                            {{ deleteError }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
