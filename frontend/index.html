<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Juridique - MIBS</title>

    <!-- Librairies JavaScript -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    
    <!-- Styles par features -->
    <link rel="stylesheet" href="shared/styles/base.css">
    <link rel="stylesheet" href="shared/styles/responsive.css">
    <link rel="stylesheet" href="shared/components/alert.css">
    <link rel="stylesheet" href="features/auth/auth.css">
    <link rel="stylesheet" href="features/chat/chat-layout.css">
    <link rel="stylesheet" href="features/chat/messages.css">
    <link rel="stylesheet" href="features/chat/typing.css">
    <link rel="stylesheet" href="features/settings/settings.css">
</head>
<body>
    <div id="app">
        <!-- Loading initial -->
        <div id="loading-screen" style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; font-family: system-ui;">
            <div class="spinner"></div>
            <p style="margin-top: 1rem; color: #667eea;">Chargement de l'application...</p>
        </div>

        <!-- Templates seront inject√©s ici -->
        <div id="app-content" style="display: none;">
            <!-- Feature: Authentification -->
            <div id="auth-feature"></div>

            <!-- Feature: Chat -->
            <div id="chat-feature"></div>

            <!-- Feature: Settings -->
            <div id="settings-feature"></div>
        </div>
    </div>

    <!-- Configuration et modules -->
    <script src="shared/config.js"></script>
    <script src="shared/components/alert.js"></script>
    <script src="features/auth/auth.js"></script>
    <script src="features/chat/discussion.js"></script>
    <script src="features/settings/settings.js"></script>
    
    <!-- Initialisation de l'application -->
    <script>
        const { createApp } = Vue;
        
        async function initializeApp() {
            try {
                console.log('üöÄ Initialisation de l\'application...');
                
                // 1. Chargement des templates
                console.log('üìÑ Chargement des templates...');
                const [authResponse, chatResponse, settingsResponse] = await Promise.all([
                    fetch('features/auth/auth.html'),
                    fetch('features/chat/chat.html'),
                    fetch('features/settings/settings.html')
                ]);

                if (!authResponse.ok || !chatResponse.ok || !settingsResponse.ok) {
                    throw new Error('Erreur lors du chargement des templates');
                }

                const [authHtml, chatHtml, settingsHtml] = await Promise.all([
                    authResponse.text(),
                    chatResponse.text(),
                    settingsResponse.text()
                ]);

                // 2. Injection des templates
                console.log('üìã Injection des templates...');
                document.getElementById('auth-feature').innerHTML = authHtml;
                document.getElementById('chat-feature').innerHTML = chatHtml;
                document.getElementById('settings-feature').innerHTML = settingsHtml;
                
                // 3. Gestion du profile menu
                const parser = new DOMParser();
                const doc = parser.parseFromString(authHtml, 'text/html');
                const profileMenu = doc.querySelector('.profile-menu');
                
                if (profileMenu) {
                    const placeholder = document.getElementById('profile-menu-placeholder');
                    if (placeholder) {
                        placeholder.innerHTML = profileMenu.outerHTML;
                    }
                }
                
                // 4. Cr√©ation de l'application Vue
                console.log('‚ö° Cr√©ation de l\'application Vue...');
                const app = createApp({
                    data() {
                        return {
                            // Configuration API
                            API_URL: AppConfig.API_URL,
                            // Fusion des donn√©es des modules
                            ...AuthModule.data,
                            ...DiscussionModule.data,
                            ...SettingsModule.data
                        };
                    },

                    computed: {
                        // Fusion des propri√©t√©s calcul√©es des modules
                        ...AuthModule.computed,
                        ...DiscussionModule.computed
                    },

                    watch: {
                        showAuthModal(newVal) {
                            const authFeature = document.getElementById('auth-feature');
                            if (authFeature) {
                                if (newVal) {
                                    authFeature.classList.add('show');
                                } else {
                                    authFeature.classList.remove('show');
                                }
                            }
                        }
                    },

                    methods: {
                        // Fusion des m√©thodes des modules
                        ...AuthModule.methods,
                        ...DiscussionModule.methods,
                        ...SettingsModule.methods
                    },

                    created() {
                        console.log('üé® Application Vue cr√©√©e');
                        this.setupAxiosInterceptors();
                    },

                    mounted() {
                        console.log('üéØ Application Vue mont√©e');

                        // Initialiser la visibilit√© de auth-feature
                        const authFeature = document.getElementById('auth-feature');
                        if (this.showAuthModal) {
                            authFeature.classList.add('show');
                        }

                        this.checkAuth();

                        // Fermer le menu profil si on clique ailleurs
                        document.addEventListener('click', (e) => {
                            if (!e.target.closest('.profile-menu')) {
                                this.showProfileDropdown = false;
                            }
                        });

                        // Masquer le loading et afficher l'app
                        document.getElementById('loading-screen').style.display = 'none';
                        document.getElementById('app-content').style.display = 'block';

                        console.log('‚úÖ Application initialis√©e avec succ√®s!');
                    },

                    beforeUnmount() {
                        this.stopPolling();
                        document.removeEventListener('click', this.handleOutsideClick);
                    }
                });
                
                // 5. Montage de l'application
                app.mount('#app');
                
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation:', error);
                document.getElementById('loading-screen').innerHTML = `
                    <div style="text-align: center; color: #dc3545;">
                        <h3>Erreur de chargement</h3>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" style="padding: 0.5rem 1rem; margin-top: 1rem;">
                            Recharger la page
                        </button>
                    </div>
                `;
            }
        }
        
        // D√©marrer l'initialisation
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>   
</body>
</html>